name: YouTube Downloader

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: "YouTube video URL"
        required: true
        type: string
      format:
        description: "Output format (mp3 or mp4)"
        required: true
        default: "mp3"
        type: choice
        options:
          - mp3
          - mp4
      quality:
        description: "Video quality (1080p, 720p, 480p â€” ignored for mp3)"
        required: false
        default: "720p"
        type: choice
        options:
          - 1080p
          - 720p
          - 480p

jobs:
  download:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Cache yt-dlp and ffmpeg
        uses: actions/cache@v3
        with:
          path: |
            ~/.local/bin/yt-dlp
            ~/.cache/yt-dlp
            ~/.local/bin/ffmpeg
          key: yt-dlp-ffmpeg-cache-v1

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip curl tar
          
          # yt-dlp
          if ! command -v yt-dlp &> /dev/null; then
            pip3 install --user yt-dlp
          fi
          echo "$HOME/.local/bin" >> $GITHUB_PATH

          # ffmpeg static
          if [ ! -f "$HOME/.local/bin/ffmpeg" ]; then
            curl -L https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz -o ffmpeg.tar.xz
            mkdir -p "$HOME/.local/bin"
            tar -xJf ffmpeg.tar.xz --strip-components=1 -C "$HOME/.local/bin" ffmpeg-*-amd64-static/ffmpeg ffmpeg-*-amd64-static/ffprobe
            chmod +x "$HOME/.local/bin/ffmpeg" "$HOME/.local/bin/ffprobe"
          fi

      - name: Run YouTube Downloader
        env:
          YT_COOKIES: ${{ secrets.YT_COOKIES }}
        run: |
          URL="${{ github.event.inputs.video_url }}"
          FORMAT="${{ github.event.inputs.format }}"
          QUALITY="${{ github.event.inputs.quality }}"
          WORKDIR="$GITHUB_WORKSPACE/downloads"
          mkdir -p "$WORKDIR"
          cd "$WORKDIR"

          echo "ðŸŽžï¸ Downloading: $URL"
          echo "ðŸ“¦ Format: $FORMAT | Quality: $QUALITY"

          if [ -n "$YT_COOKIES" ]; then
            echo "$YT_COOKIES" > cookies.txt
            COOKIE_ARG="--cookies cookies.txt"
          else
            COOKIE_ARG=""
          fi

          export YTDLP_CACHE_DIR="$HOME/.cache/yt-dlp"

          if [ "$FORMAT" = "mp3" ]; then
            yt-dlp -f bestaudio $COOKIE_ARG \
              --extract-audio --audio-format mp3 \
              --audio-quality 0 \
              --embed-thumbnail --embed-metadata \
              -o "%(title)s.%(ext)s" "$URL"
          else
            yt-dlp -f "bestvideo[height<=${QUALITY%%p}]+bestaudio/best" $COOKIE_ARG \
              --merge-output-format mp4 \
              -o "%(title)s.%(ext)s" "$URL"

      - name: Upload downloaded files
        uses: actions/upload-artifact@v4
        with:
          name: youtube_result
          path: downloads/**/*.*
