name: YouTube Downloader

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: "YouTube video URL"
        required: true
        type: string
      format:
        description: "Output format (mp3 or mp4)"
        required: true
        default: "mp3"
        type: choice
        options:
          - mp3
          - mp4
      quality:
        description: "Video quality (1080p, 720p, 480p — ignored for mp3)"
        required: false
        default: "720p" 
        type: choice
        options:
          - 1080p
          - 720p
          - 480p
      download_id: 
        description: "Unique identifier for tracking the download"
        required: true
        type: string

jobs:
  download:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Cache yt-dlp, ffmpeg, and yt-dlp cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.local/bin/yt-dlp
            ~/.local/bin/ffmpeg
            ~/.local/bin/ffprobe
            ~/.cache/yt-dlp
          key: yt-dlp-ffmpeg-cache-v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip curl tar

          # CORRECTED: Unconditionally install/upgrade yt-dlp to fix ModuleNotFoundError
          pip3 install --user --upgrade yt-dlp

          echo "$HOME/.local/bin" >> $GITHUB_PATH

          # Install static ffmpeg if missing
          if [ ! -f "$HOME/.local/bin/ffmpeg" ]; then
            curl -L https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz -o ffmpeg.tar.xz
            mkdir ffmpeg_tmp
            tar -xJf ffmpeg.tar.xz -C ffmpeg_tmp
            cp ffmpeg_tmp/*-amd64-static/ffmpeg $HOME/.local/bin/
            cp ffmpeg_tmp/*-amd64-static/ffprobe $HOME/.local/bin/
            chmod +x $HOME/.local/bin/ffmpeg $HOME/.local/bin/ffprobe
            rm -rf ffmpeg_tmp ffmpeg.tar.xz
          fi

      - name: Run YouTube Downloader
        env:
          YT_COOKIES: ${{ secrets.YT_COOKIES }}
        run: |
          URL="${{ github.event.inputs.video_url }}"
          FORMAT="${{ github.event.inputs.format }}"
          QUALITY="${{ github.event.inputs.quality }}"
          WORKDIR="$GITHUB_WORKSPACE/downloads"
          mkdir -p "$WORKDIR"
          cd "$WORKDIR"

          echo "🎞️ Downloading: $URL"
          echo "📦 Format: $FORMAT | Quality: $QUALITY"

          if [ -n "$YT_COOKIES" ]; then
            echo "$YT_COOKIES" > cookies.txt
            COOKIE_ARG="--cookies cookies.txt"
          else
            COOKIE_ARG=""
          fi

          export YTDLP_CACHE_DIR="$HOME/.cache/yt-dlp"

          if [ "$FORMAT" = "mp3" ]; then
            # This is the correct logic for mp3 extraction
            yt-dlp -f bestaudio $COOKIE_ARG \
              --extract-audio --audio-format mp3 \
              --audio-quality 0 \
              --embed-thumbnail --embed-metadata \
              -o "%(title)s.%(ext)s" "$URL"
          else
            # This logic uses the QUALITY input for video
            yt-dlp -f "bestvideo[height<=${QUALITY%%p}]+bestaudio/best" $COOKIE_ARG \
              --merge-output-format mp4 \
              --output "%(title)s.%(ext)s" "$URL"
          fi

      - name: Upload to file.io
        run: |
          cd downloads
          echo "## 📤 File.io Links (14 days)" >> $GITHUB_STEP_SUMMARY
          DOWNLOADED_FILES=$(ls -1 | grep -v 'cookies\.txt' | tr '\n' ' ')

          if [ -z "$DOWNLOADED_FILES" ]; then
            echo "❌ No video/audio file found for upload. Check previous step logs." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          for file in $DOWNLOADED_FILES; do
            if [ -f "$file" ]; then
              echo "Uploading $file to file.io..."
              RESPONSE=$(curl -F "file=@$file" https://file.io)
              echo "Response: $RESPONSE"
    
              DOWNLOAD_URL=$(echo "$RESPONSE" | sed -n 's/.*"link":"\([^"]*\)".*/\1/p')
              if [ -z "$DOWNLOAD_URL" ]; then
                  DOWNLOAD_URL=$(echo "$RESPONSE" | grep -o '"link":"[^"]*' | cut -d'"' -f4)
              fi
              if [ -n "$DOWNLOAD_URL" ]; then
                echo "- **$file**: [Download Here]($DOWNLOAD_URL)" >> $GITHUB_STEP_SUMMARY
                echo "✅ File.io link: $DOWNLOAD_URL"
              else
                ERROR_MSG=$(echo "$RESPONSE" | sed -n 's/.*"message":"\([^"]*\)".*/\1/p')
                
                echo "❌ Failed to get download URL for $file"
                echo "File.io Error: ${ERROR_MSG:-Unknown}"
                echo "- **$file**: Upload failed (Error: ${ERROR_MSG:-Unknown})" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done